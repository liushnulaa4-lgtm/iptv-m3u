name: Update IPTV Sources

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-sources:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update IPTV Sources
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESULTS_PER_ISP=10
          CURRENT_DATE=$(date +%Y/%m/%d)
          TEMP_DIR=$(mktemp -d)
          
          echo "å¼€å§‹æœç´¢ IPTV æº..."
          
          # ç§»åŠ¨ IPTV
          echo "æœç´¢ç§»åŠ¨ IPTV..."
          curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/search/repositories?q=ç§»åŠ¨+iptv&sort=updated&order=desc&per_page=$RESULTS_PER_ISP" > "$TEMP_DIR/mobile.json"
          
          echo "API å“åº”å†…å®¹:"
          head -20 "$TEMP_DIR/mobile.json"
          echo ""
          
          if ! jq empty "$TEMP_DIR/mobile.json" 2>/dev/null; then
            echo "é”™è¯¯ï¼šJSON æ ¼å¼æ— æ•ˆ"
            cat "$TEMP_DIR/mobile.json"
            exit 1
          fi
          
          # ä½¿ç”¨ç®€åŒ–çš„ jq å‘½ä»¤
          jq -r '.items[] | @csv' "$TEMP_DIR/mobile.json" | \
            awk -v FPAT='[^,]*|"[^"]+"' '{
              # è§£æ CSV
              gsub(/^"|"$/, "", $1);
              gsub(/^"|"$/, "", $2);
              gsub(/^"|"$/, "", $3);
              gsub(/^"|"$/, "", $4);
              print $1 "|" substr($3,2,10) "|" $4 "|" $5 "|" $7
            }' > "$TEMP_DIR/mobile_repos.txt"
          
          # ç”Ÿæˆç§»åŠ¨ IPTV Markdown
          cat > "$TEMP_DIR/mobile.md" << 'EOF'
          ## ğŸ“± ç§»åŠ¨ IPTV M3U æº
          
          | æ’å | çœä»½/åœ°åŒº | æ›´æ–°æ—¶é—´ | æ ¼å¼ | æ˜Ÿæ ‡ | M3Uåœ°å€ | ç‰¹ç‚¹ |
          |------|----------|---------|------|------|---------|------|
          EOF
          
          rank=1
          while IFS='|' read -r name updated stars description full_name; do
            [ -z "$name" ] && continue
            
            # ç®€åŒ–å¤„ç†ï¼Œåªæ˜¾ç¤ºä»“åº“é“¾æ¥
            echo "| $rank | [$name](https://github.com/$full_name) | $updated | - | $stars | [æŸ¥çœ‹ä»“åº“](https://github.com/$full_name) | $description |" >> "$TEMP_DIR/mobile.md"
            ((rank++))
          done < "$TEMP_DIR/mobile_repos.txt"
          
          # ç”µä¿¡ IPTV
          echo "æœç´¢ç”µä¿¡ IPTV..."
          curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/search/repositories?q=ç”µä¿¡+iptv&sort=updated&order=desc&per_page=$RESULTS_PER_ISP" > "$TEMP_DIR/telecom.json"
          
          if ! jq empty "$TEMP_DIR/telecom.json" 2>/dev/null; then
            echo "é”™è¯¯ï¼šJSON æ ¼å¼æ— æ•ˆ"
            cat "$TEMP_DIR/telecom.json"
            exit 1
          fi
          
          jq -r '.items[] | @csv' "$TEMP_DIR/telecom.json" | \
            awk -v FPAT='[^,]*|"[^"]+"' '{
              gsub(/^"|"$/, "", $1);
              gsub(/^"|"$/, "", $2);
              gsub(/^"|"$/, "", $3);
              gsub(/^"|"$/, "", $4);
              print $1 "|" substr($3,2,10) "|" $4 "|" $5 "|" $7
            }' > "$TEMP_DIR/telecom_repos.txt"
          
          cat > "$TEMP_DIR/telecom.md" << 'EOF'
          ## ğŸ“ ç”µä¿¡ IPTV M3U æº
          
          | æ’å | çœä»½/åœ°åŒº | æ›´æ–°æ—¶é—´ | æ ¼å¼ | æ˜Ÿæ ‡ | M3Uåœ°å€ | ç‰¹ç‚¹ |
          |------|----------|---------|------|------|---------|------|
          EOF
          
          rank=1
          while IFS='|' read -r name updated stars description full_name; do
            [ -z "$name" ] && continue
            echo "| $rank | [$name](https://github.com/$full_name) | $updated | - | $stars | [æŸ¥çœ‹ä»“åº“](https://github.com/$full_name) | $description |" >> "$TEMP_DIR/telecom.md"
            ((rank++))
          done < "$TEMP_DIR/telecom_repos.txt"
          
          # è”é€š IPTV
          echo "æœç´¢è”é€š IPTV..."
          curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/search/repositories?q=è”é€š+iptv&sort=updated&order=desc&per_page=$RESULTS_PER_ISP" > "$TEMP_DIR/unicom.json"
          
          if ! jq empty "$TEMP_DIR/unicom.json" 2>/dev/null; then
            echo "é”™è¯¯ï¼šJSON æ ¼å¼æ— æ•ˆ"
            cat "$TEMP_DIR/unicom.json"
            exit 1
          fi
          
          jq -r '.items[] | @csv' "$TEMP_DIR/unicom.json" | \
            awk -v FPAT='[^,]*|"[^"]+"' '{
              gsub(/^"|"$/, "", $1);
              gsub(/^"|"$/, "", $2);
              gsub(/^"|"$/, "", $3);
              gsub(/^"|"$/, "", $4);
              print $1 "|" substr($3,2,10) "|" $4 "|" $5 "|" $7
            }' > "$TEMP_DIR/unicom_repos.txt"
          
          cat > "$TEMP_DIR/unicom.md" << 'EOF'
          ## ğŸ”µ è”é€š IPTV M3U æº
          
          | æ’å | çœä»½/åœ°åŒº | æ›´æ–°æ—¶é—´ | æ ¼å¼ | æ˜Ÿæ ‡ | M3Uåœ°å€ | ç‰¹ç‚¹ |
          |------|----------|---------|------|------|---------|------|
          EOF
          
          rank=1
          while IFS='|' read -r name updated stars description full_name; do
            [ -z "$name" ] && continue
            echo "| $rank | [$name](https://github.com/$full_name) | $updated | - | $stars | [æŸ¥çœ‹ä»“åº“](https://github.com/$full_name) | $description |" >> "$TEMP_DIR/unicom.md"
            ((rank++))
          done < "$TEMP_DIR/unicom_repos.txt"
          
          # åˆå¹¶æˆå®Œæ•´çš„ README
          cat > README.md << EOF
          # ä¸­å›½ IPTV M3U æºåˆ—è¡¨ï¼ˆæŒ‰è¿è¥å•†åˆ†ç±»ï¼‰
          
          > æœ€åæ›´æ–°: $CURRENT_DATE
          
          ---
          
          EOF
          
          cat "$TEMP_DIR/mobile.md" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          cat "$TEMP_DIR/telecom.md" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          cat "$TEMP_DIR/unicom.md" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          
          cat >> README.md << 'ENDMARKER'
          ## ä½¿ç”¨è¯´æ˜
          
          ### ç½‘ç»œè¦æ±‚
          - è¿™äº›æºéœ€è¦åœ¨å¯¹åº”è¿è¥å•†çš„ç½‘ç»œç¯å¢ƒä¸‹ä½¿ç”¨
          - ç§»åŠ¨ IPTV éœ€è¦ä¸­å›½ç§»åŠ¨ç½‘ç»œç¯å¢ƒ
          - ç”µä¿¡ IPTV éœ€è¦ä¸­å›½ç”µä¿¡ç½‘ç»œç¯å¢ƒ
          - è”é€š IPTV éœ€è¦ä¸­å›½è”é€šç½‘ç»œç¯å¢ƒ
          
          ### æ’­æ”¾å™¨æ¨è
          - **Android**: mytv-androidã€IPTV Pro
          - **Windows**: Potplayerã€VLC Media Player
          - **iOS**: GSE IPTVã€nPlayer
          - **macOS**: IINAã€VLC Media Player
          
          ### å¸¸è§é—®é¢˜
          1. **æ— æ³•æ’­æ”¾**: è¯·æ£€æŸ¥ç½‘ç»œç¯å¢ƒï¼Œç¡®ä¿ä½¿ç”¨å¯¹åº”çš„è¿è¥å•†ç½‘ç»œ
          2. **éƒ¨åˆ†é¢‘é“ä¸å¯ç”¨**: å¯èƒ½æ˜¯æºå¤±æ•ˆï¼Œå»ºè®®ä½¿ç”¨æœ€æ–°æ›´æ–°çš„æº
          3. **åŠ è½½ç¼“æ…¢**: å»ºè®®ä½¿ç”¨ jsDelivr æˆ–å…¶ä»– CDN é•œåƒåŠ é€Ÿ
          
          ### é•œåƒåŠ é€Ÿ
          éƒ¨åˆ†ä»“åº“æä¾›äº†é•œåƒåŠ é€Ÿè®¿é—®ï¼š
          - jsDelivr: `https://cdn.jsdelivr.net/gh/ç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯/æ–‡ä»¶è·¯å¾„`
          - GitHub Proxy: `https://ghproxy.com/https://raw.githubusercontent.com/ç”¨æˆ·å/ä»“åº“å/åˆ†æ”¯/æ–‡ä»¶è·¯å¾„`
          
          ---
          
          > æœ¬é¡¹ç›®ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°ï¼Œæ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹è‡ªåŠ¨åŒæ­¥æœ€æ–°æ•°æ®
          > æ•°æ®æ¥æº: GitHub å…¬å¼€ä»“åº“æœç´¢ç»“æœ
          
          ## License
          [CC0-1.0 license](https://github.com/public-domain/cc-zero-1.0)
          ENDMARKER
          
          rm -rf "$TEMP_DIR"
          echo "âœ“ README.md ç”Ÿæˆå®Œæˆ"

      - name: Archive old readme
        run: |
          if [ -f "README.md" ]; then
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            mv "README.md" "README_${TIMESTAMP}.md"
            ls -t README_*.md | tail -n +31 | xargs -r rm -f
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md README_*.md || true
          if git diff --staged --quiet; then
            echo "âœ“ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "Update IPTV sources - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ“ å·²æ¨é€åˆ° GitHub"
          fi
