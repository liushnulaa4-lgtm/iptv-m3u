name: Update IPTV Sources

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹è¿è¡Œ (UTC 00:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  update-sources:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Update IPTV Sources
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # é…ç½®
          RESULTS_PER_ISP=10
          CURRENT_DATE=$(date +%Y/%m/%d)
          
          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶
          TEMP_DIR=$(mktemp -d)
          MOBILE_FILE="$TEMP_DIR/mobile.md"
          TELECOM_FILE="$TEMP_DIR/telecom.md"
          UNICOM_FILE="$TEMP_DIR/unicom.md"
          
          echo "å¼€å§‹æœç´¢ IPTV æº..."
          
          # æœç´¢ç§»åŠ¨ IPTV
          echo "æœç´¢ç§»åŠ¨ IPTV..."
          echo "## ğŸ“± ç§»åŠ¨ IPTV M3U æº" >> "$MOBILE_FILE"
          echo "" >> "$MOBILE_FILE"
          echo "| æ’å | çœä»½/åœ°åŒº | æ›´æ–°æ—¶é—´ | æ ¼å¼ | æ˜Ÿæ ‡ | M3Uåœ°å€ | ç‰¹ç‚¹ |" >> "$MOBILE_FILE"
          echo "|------|----------|---------|------|------|---------|------|" >> "$MOBILE_FILE"
          
          # ä½¿ç”¨ curl å’Œ jq æœç´¢å¹¶å¤„ç†
          curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/search/repositories?q=ç§»åŠ¨+iptv+language:all+type:repositories&sort=updated&order=desc&per_page=50" | \
            jq -r '.items[:'"$RESULTS_PER_ISP"'] | .[] | "\(.name)|\(.updated_at[0:10])|â­\(.stargazers_count)|\(.description // "æš‚æ— æè¿°")|\(.owner.login)/\(.name)"' > "$TEMP_DIR/mobile_repos.txt"
          
          # å¤„ç†ç§»åŠ¨ IPTV ç»“æœ
          rank=1
          while IFS='|' read -r name updated stars description full_name; do
            # è·å–ä»“åº“æ–‡ä»¶
            files=$(curl -s -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$full_name/contents" | \
              jq -r '.[] | select(.type == "file" and (.name | endswith(".m3u") or endswith(".m3u8"))) | "\(.name)|\(.download_url)"')
            
            m3u_link="[æŸ¥çœ‹ä»“åº“](https://github.com/$full_name)"
            file_format="-"
            
            if [ -n "$files" ]; then
              first_file=$(echo "$files" | head -n 1)
              file_name=$(echo "$first_file" | cut -d'|' -f1)
              file_url=$(echo "$first_file" | cut -d'|' -f2)
              file_format=".${file_name##*.}"
              m3u_link="[$file_name]($file_url)"
            fi
            
            echo "| $rank | [$name](https://github.com/$full_name) | $updated | $file_format | $stars | $m3u_link | $description |" >> "$MOBILE_FILE"
            ((rank++))
          done < "$TEMP_DIR/mobile_repos.txt"
          
          # æœç´¢ç”µä¿¡ IPTV
          echo "æœç´¢ç”µä¿¡ IPTV..."
          echo "## ğŸ“ ç”µä¿¡ IPTV M3U æº" >> "$TELECOM_FILE"
          echo "" >> "$TELECOM_FILE"
          echo "| æ’å | çœä»½/åœ°åŒº | æ›´æ–°æ—¶é—´ | æ ¼å¼ | æ˜Ÿæ ‡ | M3Uåœ°å€ | ç‰¹ç‚¹ |" >> "$TELECOM_FILE"
          echo "|------|----------|---------|------|------|---------|------|" >> "$TELECOM_FILE"
          
          curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/search/repositories?q=ç”µä¿¡+iptv+language:all+type:repositories&sort=updated&order=desc&per_page=50" | \
            jq -r '.items[:'"$RESULTS_PER_ISP"'] | .[] | "\(.name)|\(.updated_at[0:10])|â­\(.stargazers_count)|\(.description // "æš‚æ— æè¿°")|\(.owner.login)/\(.name)"' > "$TEMP_DIR/telecom_repos.txt"
          
          rank=1
          while IFS='|' read -r name updated stars description full_name; do
            files=$(curl -s -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$full_name/contents" | \
              jq -r '.[] | select(.type == "file" and (.name | endswith(".m3u") or endswith(".m3u8"))) | "\(.name)|\(.download_url)"')
            
            m3u_link="[æŸ¥çœ‹ä»“åº“](https://github.com/$full_name)"
            file_format="-"
            
            if [ -n "$files" ]; then
              first_file=$(echo "$files" | head -n 1)
              file_name=$(echo "$first_file" | cut -d'|' -f1)
              file_url=$(echo "$first_file" | cut -d'|' -f2)
              file_format=".${file_name##*.}"
              m3u_link="[$file_name]($file_url)"
            fi
            
            echo "| $rank | [$name](https://github.com/$full_name) | $updated | $file_format | $stars | $m3u_link | $description |" >> "$TELECOM_FILE"
            ((rank++))
          done < "$TEMP_DIR/telecom_repos.txt"
          
          # æœç´¢è”é€š IPTV
          echo "æœç´¢è”é€š IPTV..."
          echo "## ğŸ”µ è”é€š IPTV M3U æº" >> "$UNICOM_FILE"
          echo "" >> "$UNICOM_FILE"
          echo "| æ’å | çœä»½/åœ°åŒº | æ›´æ–°æ—¶é—´ | æ ¼å¼ | æ˜Ÿæ ‡ | M3Uåœ°å€ | ç‰¹ç‚¹ |" >> "$UNICOM_FILE"
          echo "|------|----------|---------|------|------|---------|------|" >> "$UNICOM_FILE"
          
          curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/search/repositories?q=è”é€š+iptv+language:all+type:repositories&sort=updated&order=desc&per_page=50" | \
            jq -r '.items[:'"$RESULTS_PER_ISP"'] | .[] | "\(.name)|\(.updated_at[0:10])|â­\(.stargazers_count)|\(.description // "æš‚æ— æè¿°")|\(.owner.login)/\(.name)"' > "$TEMP_DIR/unicom_repos.txt"
          
          rank=1
          while IFS='|' read -r name updated stars description full_name; do
            files=$(curl -s -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/$full_name/contents" | \
              jq -r '.[] | select(.type == "file" and (.name | endswith(".m3u") or endswith(".m3u8"))) | "\(.name)|\(.download_url)"')
            
            m3u_link="[æŸ¥çœ‹ä»“åº“](https://github.com/$full_name)"
            file_format="-"
            
            if [ -n "$files" ]; then
              first_file=$(echo "$files" | head -n 1)
              file_name=$(echo "$first_file" | cut -d'|' -f1)
              file_url=$(echo "$first_file" | cut -d'|' -f2)
              file_format=".${file_name##*.}"
              m3u_link="[$file_name]($file_url)"
            fi
            
            echo "| $rank | [$name](https://github.com/$full_name) | $updated | $file_format | $stars | $m3u_link | $description |" >> "$UNICOM_FILE"
            ((rank++))
          done < "$TEMP_DIR/unicom_repos.txt"
          
          # åˆå¹¶æˆå®Œæ•´çš„ README
          echo "# ä¸­å›½ IPTV M3U æºåˆ—è¡¨ï¼ˆæŒ‰è¿è¥å•†åˆ†ç±»ï¼‰" > README.md
          echo "" >> README.md
          echo "> æœ€åæ›´æ–°: $CURRENT_DATE" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          cat "$MOBILE_FILE" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          cat "$TELECOM_FILE" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          cat "$UNICOM_FILE" >> README.md
          echo "" >> README.md
          echo "---" >> README.md
          echo "" >> README.md
          
          # æ·»åŠ ä½¿ç”¨è¯´æ˜
          cat << 'EOF' >> README.md
          ## ä½¿ç”¨è¯´æ˜
          
          ### ç½‘ç»œè¦æ±‚
          - è¿™äº›æºéœ€è¦åœ¨å¯¹åº”è¿è¥å•†çš„ç½‘ç»œç¯å¢ƒä¸‹ä½¿ç”¨
          - ç§»åŠ¨ IPTV éœ€è¦ä¸­å›½ç§»åŠ¨ç½‘ç»œç¯å¢ƒ
          - ç”µä¿¡ IPTV éœ€è¦ä¸­å›½ç”µä¿¡ç½‘ç»œç¯å¢ƒ
          - è”é€š IPTV éœ€è¦ä¸­å›½è”é€šç½‘ç»œç¯å¢ƒ
          
          ### æ’­æ”¾å™¨æ¨è
          - **Android**: mytv-androidã€IPTV Pro
          - **Windows**: Potplayerã€VLC Media Player
          - **iOS**: GSE IPTVã€nPlayer
          - **macOS**: IINAã€VLC Media Player
          
          ### å¸¸è§é—®é¢˜
          1. **æ— æ³•æ’­æ”¾**: è¯·æ£€æŸ¥ç½‘ç»œç¯å¢ƒï¼Œç¡®ä¿ä½¿ç”¨å¯¹åº”çš„è¿è¥å•†ç½‘ç»œ
          2. **éƒ¨åˆ†é¢‘é“ä¸å¯ç”¨**: å¯èƒ½æ˜¯æºå¤±æ•ˆï¼Œå»ºè®®ä½¿ç”¨æœ€æ–°æ›´æ–°çš„æº
          3. **åŠ è½½ç¼“æ…¢**: å»ºè®®ä½¿ç”¨ jsDelivr æˆ–å…¶ä»– CDN é•œåƒåŠ é€Ÿ
          
          ### é•œåƒåŠ é€Ÿ
          éƒ¨åˆ†ä»“åº“æä¾›äº†é•œåƒåŠ é€Ÿè®¿é—®ï¼š
          - jsDelivr: `https://cdn.jsdelivr.net/gh/ç”¨æˆ·å/ä»“åº“å@åˆ†æ”¯/æ–‡ä»¶è·¯å¾„`
          - GitHub Proxy: `https://ghproxy.com/https://raw.githubusercontent.com/ç”¨æˆ·å/ä»“åº“å/åˆ†æ”¯/æ–‡ä»¶è·¯å¾„`
          
          ---
          
          > æœ¬é¡¹ç›®ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°ï¼Œæ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹è‡ªåŠ¨åŒæ­¥æœ€æ–°æ•°æ®
          > æ•°æ®æ¥æº: GitHub å…¬å¼€ä»“åº“æœç´¢ç»“æœ
          
          ## License
          [CC0-1.0 license](https://github.com/public-domain/cc-zero-1.0)
          EOF
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf "$TEMP_DIR"
          
          echo "âœ“ README.md ç”Ÿæˆå®Œæˆ"

      - name: Archive old readme
        run: |
          if [ -f "README.md" ]; then
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            mv "README.md" "README_${TIMESTAMP}.md"
            echo "âœ“ å·²å½’æ¡£ä¸º README_${TIMESTAMP}.md"
            # åªä¿ç•™æœ€è¿‘30ä¸ªå†å²æ–‡ä»¶
            ls -t README_*.md | tail -n +31 | xargs -r rm -f
            echo "âœ“ å·²æ¸…ç†æ—§çš„å†å²æ–‡ä»¶"
          fi

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add README.md README_*.md || true
          if git diff --staged --quiet; then
            echo "âœ“ æ²¡æœ‰éœ€è¦æäº¤çš„æ›´æ”¹"
          else
            git commit -m "Update IPTV sources - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ“ å·²æ¨é€åˆ° GitHub"
          fi
